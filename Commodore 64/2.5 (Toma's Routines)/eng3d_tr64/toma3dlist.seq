0 REM * 3DENGINE 2.5 TOMA'S ROUTINES VERSION FOR C64 * GP 02/251 POKE53280,0:POKE53281,0:GOSUB 3200:PA=52 _TEXT0,PA:INPUT "SET DOT AND LINE COLOR (1-15)";PA3 IF PA=0 OR PA>15 THEN GOTO 24 _CLEAR:_GRAF 0,PA:_COLOR 1:_CHAR 0,20,0,"OK (Y/N) ?"5 GET PA$:IF PA$="" THEN 57 IF PA$="Y" THEN GOTO 108 IF PA$="N" THEN GOTO 29 GOTO 510 _TEXT 0,PAL:POKE 50151,19920 _CLEAR:_GRAF 0,PAL:FC=0:_COLOR 130 GX=5:GY=150:GZ=180:P=3.14159265359/18040 CF=1:CD=0:CC=100:REM CF1CD0 FOR NO FILLED POLYGONS50 FS=400:DX=-50:DY=100:L=16:CP=2.60 OPEN8,8,12,"VERTEX,SEQ,READ"70 INPUT#8,C,D,H,U:DIMU(U):DIMSL(U)80 DIMX%(C):DIMY%(C):DIMZ%(C):DIMXI(U)90 DIMVX%(C):DIMVY%(C):FR=FRE(0)-600:FR=INT((FR/2)/7)100 DIMOO%(FR):DIMOI%(FR):DIMFF%(FR*5)110 _CHAR 0,0,0,"LOADING VERTICES ": REM + STR$(FR) + " " + STR$(FRE(0))120 FORA=1TOC:130 INPUT#8,X%(A),Y%(A),Z%(A)150 _CHAR 0,1,0,STR$(A)+"/"+STR$(C)160 NEXT170 CLOSE8: GOTO 470210 REM220 GET A$:IFA$=""THEN220230 IFA$="X"THENGOSUB3200:PRINT"ANGLE X-AXIS ("+STR$(GX)+")":INPUTGX:_GRAF0,PA240 IFA$="Y"THENGOSUB3200:PRINT"ANGLE Y-AXIS ("+STR$(GY)+")":INPUTGY:_GRAF0,PA250 IFA$="Z"THENGOSUB3200:PRINT"ANGLE Z-AXIS ("+STR$(GZ)+")":INPUTGZ:_GRAF0,PA320 IFA$="V"THENGOSUB3200:PRINT"VERT POS DY ("+STR$(DY)+")":INPUTDY:_GRAF0,PA330 IFA$="H"THENGOSUB3200:PRINT"HORIZ POS DX ("+STR$(DX)+")":INPUTDX:_GRAF0,PA340 IFA$="C"THENGOSUB3200:PRINT"ONLY F OV CP ("+STR$(CP)+")":INPUTCP:_GRAF0,PA355 IFA$="P"THENGOSUB3000:_GRAF0,PAL:GOTO220356 IFA$="F"THEN GOSUB 2398:GOTO220357 IFA$="B"THEN PRINT CHR$(147):CLR:GOTO 1370 IFA$="E"THENGOSUB3200:PRINT"FISHEYE FS ("+STR$(FS)+")":INPUTFS:_GRAF 0,PA390 IFA$="M"THENGOSUB3200:PRINT"ZOOM L ("+STR$(L)+")":INPUTL:_GRAF 0,PA410 IFA$="L"THEN:_CLEAR:TI$="000000":GOTO690412 IFA$="Q"THEN:_TEXT 0,5:PRINT CHR$(147):END413 IFA$="D"THEN CF=(NOT(CF))+2:CD=(NOT(CD))+2415 IFA$="A"AND GP=0 THEN:_CHAR 0,24,0,"KEY: XYZ HV CPFBEMLQ":GP=1:GOTO 220416 IFA$="A"AND GP=1 THEN:_CHAR 0,24,0,"                    ":GP=0:GOTO 220430 IFA$="I"THENGOSUB3100:GOTO220470 REM7290480 _CLEAR500 RX=GX*P510 RY=GY*P520 RZ=GZ*P530 CX=COS(RX):SX=SIN(RX)540 CY=COS(RY):SY=SIN(RY)550 CZ=COS(RZ):SZ=SIN(RZ)570 FORNP=1TOC580 XP=X%(NP)/D*L590 YP=Y%(NP)/D*L600 ZP=Z%(NP)/D*L620 GOSUB1290630 X1=DX+INT(((XP*FS)/(ZP+FS))+0.5)640 Y1=DY+INT(((YP*FS)/(ZP+FS))+0.5)641 VX%(NP)=X1642 VY%(NP)=Y1650 _PLOT X1,-Y1,0660 NEXT670 _CHAR 0,0,0,"!":GOTO210690 POKE 53280,0698 _CHAR 0,0,0,"FIND FACES " :REM  + STR$(FRE(0))700 OPEN8,8,12,"PLANES,SEQ,READ"710 I=1:FR=0:FF=0:II=0:FV=0720 FORA=1TOH725 IFI=1THENINPUT#8,M1,M2,M3:GOSUB4000730 INPUT#8,V740 U(I)=V:750 IFV>0THENI=I+1:760 IFNOTV>0THEN FR=FR+1:GOSUB790:I=1770 NEXT780 CLOSE8:GOSUB1500:GOTO 210790 REM11000791 IFVS=0THENRETURN792 GOSUB 2390:REM CHAR 0,3,0,"AR:"+STR$(AR)+" " + STR$(I):793 IF AR<=CP THEN RETURN810 OO=0820 FORG=1TOI-2830 _DRAW VX%(U(G)),-VY%(U(G)),0,VX%(U(G+1)),-VY%(U(G+1)),0831 XP=X%(U(G)):YP=Y%(U(G)):ZP=Z%(U(G))832 GOSUB1290840 OO=OO+ZP850 NEXT851 XP=X%(U(G)):YP=Y%(U(G)):ZP=Z%(U(G))852 GOSUB1290860 _DRAW VX%(U(G)),-VY%(U(G)),0,VX%(U(1)),-VY%(U(1)),0870 REM1190 OO=OO+ZP/G:G=I:1200 FF=FF+1: _CHAR 0,1,0,"F:"+STR$(FF)1210 FV=FV+G:REM _CHAR 0,2,0,"V:"+STR$(FV)1220 OO%(FF) = OO1221 OI%(FF)=II+11230 FORYY=1TOG-11240 FF%(II+YY)=U(YY)1250 NEXT1260 FF%(II+G)=FR*(-1):II=II+G1270 RETURN1290 REM400001300 YT=YP:YP=CX*YT-SX*ZP:ZP=SX*YT+CX*ZP1310 XT=XP:XP=CY*XT+SY*ZP:ZP=-SY*XT+CY*ZP1320 XT=XP:XP=CZ*XT-SZ*YP:YP=SZ*XT+CZ*YP1330 RETURN1350 REM400041360 X1=VX%(P1):Y1=VY%(P1)1370 X2=VX%(P2):Y2=VY%(P2)1380 X3=VX%(P3):Y3=VY%(P3)1390 RETURN1410 REM400201420 REM SHELL SORT1430 W1=FF1431 _CHAR 0,2,0,"         "1432 _CHAR 0,3,0,"         "1435 _CHAR 0,1,0,STR$(FF)+"->"+STR$(W1)+ "    "1440 IF W1<=0 THEN 14801445 W1=INT(W1/2): W2=FF-W11450 V=01455 FOR N1=0 TO W21460 W3=N1+W11465 IF OO%(N1)<OO%(W3)THEN GOSUB1477: V=11470 NEXT N11475 IF V>0 THEN 14501476 GOTO 14351477 S1=OO%(N1): OO%(N1)=OO%(W3): OO%(W3)=S11479 S1=OI%(N1): OI%(N1)=OI%(W3): OI%(W3)=S11480 RETURN1500 REM419991510 REMZEICHNESICHTBAREFACES1520 _CHAR 0,0,0,"SORT":_CHAR 0,2,0,""1530 GOSUB14101531 _CHAR 25,0,0,"<=, =>."1535 GET A$:IF A$="" THEN GOTO 15351536 IF A$="," THEN GOTO 4701537 IF A$="." THEN GOTO 15401538 IF NOTA$=","ORNOTA$="."THEN 15351540 _CLEAR1550 K=11560 FORJ=1TOFF1570 FORI=OI%(J)TOFV1580 U(K)=FF%(I)1590 IFFF%(I)>0THENK=K+11600 IFFF%(I)<0THENGOSUB1970:K=1:GOTO16401620 NEXTI1630 REM421111640 NEXTJ1646 GET P$:IF P$="" THEN GOTO 16461647 GOTO 4701650 RETURN1670 REMLIS FACES1970 G=K:REM612001971 IFU(G)<-1THENCS=3:1972 IFNOT U(G)<-1 THEN CS=21980 N=G-1:IT=I:JT=J:TX=DX:TY=DY:TK=K:YN=200:YX=0:UG=U(G):U(G)=U(1)2000 FORI=1TON2010 IFVY%(U(I))<YNTHENYN=VY%(U(I))2020 IFVY%(U(I))>YXTHENYX=VY%(U(I))2030 DY=VY%(U(I+1))-VY%(U(I))2040 DX=VX%(U(I+1))-VX%(U(I))2050 IFDY=0THENSL(I)=1.02060 IFDX=0THENSL(I)=0.02070 IF DY<>0 AND DX<>0 THENSL(I)=DX/DY2080 NEXT2100 FORY=YNTOYX-12110 K=02130 FORI=1TON2140 IF VY%(U(I))<=Y AND VY%(U(I+1))>Y  THENGOSUB23502150 IF  VY%(U(I))>Y AND VY%(U(I+1))<=Y  THENGOSUB23502160 NEXT2180 FORJ=0TOK-22190 FORI=0TOK-22200 IFXI(I)>XI(I+1)THENT=XI(I):XI(I)=XI(I+1):XI(I+1)=T2210 NEXT2220 NEXT2240 FORI=0TOK-1STEP22245 _COLOR CD2250 _DRAW XI(I),-Y,0,XI(I+1),-Y,02260 NEXT2270 NEXT2290 FORI=1TON2295 _COLOR CF2300 _DRAW VX%(U(I)),-VY%(U(I)),0,VX%(U(I+1)),-VY%(U(I+1)),02310 NEXT2330 I=IT:J=JT:DX=TX:DY=TY:K=TK:U(G)=UG2340 RETURN2350 REM616002360 XI(K)=VX%(U(I))+SL(I)*(Y-VY%(U(I)))2370 K=K+12380 RETURN2390 AR = 02391 AJ = I-12392 FOR AI=1 TO I-12393 AR=AR+(VX%(U(AJ))+VX%(U(AI)))*(VY%(U(AJ))-VY%(U(AI)))2394 AJ=AI2395 NEXT AI2396 AR=ABS(AR/2)2397 RETURN2398 IFFC=0 THEN POKE 53280,1:FC=1:GOTO 24002399 IFNOTFC=0 THEN POKE 53280,0:FC=02400 RETURN3000 REM GFX SAVE ROUTINE3010 GOSUB 32003020 INPUT "FILENAME";FI$3030 N=83040 _GRSAVE FI$,N3050 RETURN3100 JP1$="GX:"+STR$(GX)+" DX:"+STR$(DX)+" L:"+STR$(L):_CHAR 0,0,0,JP1$3110 JP2$="GY:"+STR$(GY)+" DY:"+STR$(DY)+" M:" + STR$(FRE(0)):_CHAR 0,1,0,JP2$3120 JP3$="GZ:"+STR$(GZ)+" FS:"+STR$(FS)+" CD:" + STR$(CD):_CHAR 0,2,0,JP3$3130 RETURN3200 _TEXT 0,5:FORI=0TO20:PRINTCHR$(13):NEXT3201 PRINTTAB(12)"3D ENGINE 2.5":PRINTCHR$(13)3210 RETURN4000 XP=M1:YP=M2:ZP=M34620 GOSUB12904670 VS=0:IFZP<0.0THENVS=14780 RETURNREADY.